<div class="crear-lista-container" [class.modal-mode]="modal">
  <!-- Bot√≥n circular de cerrar para modo modal -->
  <button 
    *ngIf="modal"
    type="button"
    class="modal-close-btn"
    (click)="onCancelar()"
    aria-label="Cerrar modal">
    X
  </button>
  
  <!-- Header bar similar al visu-dashboard -->
  <div class="header-bar" *ngIf="!modal">
    <h2>üéµ {{ tituloModal }}</h2>
    <button class="btn btn-secondary" (click)="volver()">üè† Volver al Dashboard</button>
  </div>

  <!-- T√≠tulo principal -->
  <div class="page-header">
    <h1>{{ tituloModal }}</h1>
    <p>Complete los campos para {{ listaParaEditar ? 'actualizar' : 'crear' }} su lista personalizada</p>
  </div>

  <!-- Mensaje de √©xito -->
  <div *ngIf="mensajeExito" class="alert alert-success">
    {{ mensajeExito }}
  </div>

  <!-- Mensaje de error para nombres duplicados -->
  <div *ngIf="mensajeErrorNombre" class="alert alert-error">
    {{ mensajeErrorNombre }}
  </div>

  <form [formGroup]="listaForm" (ngSubmit)="onSubmit()" class="crear-lista-form">
    <!-- Informaci√≥n b√°sica -->
    <div class="form-section">
      <h2>Informaci√≥n b√°sica</h2>
      
      <!-- Campo Nombre -->
      <div class="form-field">
        <label for="nombre">Nombre de la lista *</label>
        <input 
          id="nombre"
          type="text" 
          formControlName="nombre"
          class="full-width"
          placeholder="Ej: Mi lista de m√∫sica favorita"
          aria-label="Nombre de la lista">
        <div class="error" *ngIf="listaForm.get('nombre')?.invalid && listaForm.get('nombre')?.touched">
          <span *ngIf="listaForm.get('nombre')?.errors?.['required']">‚ö†Ô∏è El nombre es requerido</span>
          <span *ngIf="listaForm.get('nombre')?.errors?.['minlength']">‚ö†Ô∏è M√≠nimo 3 caracteres</span>
        </div>
      </div>

      <!-- Campo Descripci√≥n -->
      <div class="form-field">
        <label for="descripcion">Descripci√≥n *</label>
        <textarea 
          id="descripcion"
          formControlName="descripcion"
          rows="3"
          class="full-width"
          placeholder="Describe tu lista..."
          aria-label="Descripci√≥n de la lista"></textarea>
        <div class="error" *ngIf="listaForm.get('descripcion')?.invalid && listaForm.get('descripcion')?.touched">
          <span *ngIf="listaForm.get('descripcion')?.errors?.['required']">‚ö†Ô∏è La descripci√≥n es requerida</span>
          <span *ngIf="listaForm.get('descripcion')?.errors?.['minlength']">‚ö†Ô∏è M√≠nimo 10 caracteres</span>
        </div>
      </div>

      <!-- Campo Especializaci√≥n (solo para gestores) -->
      <div class="form-field" *ngIf="modo === 'gestor'">
        <label for="especializacion">Especializaci√≥n del gestor *</label>
        <select 
          id="especializacion"
          formControlName="especializacion"
          class="full-width"
          aria-label="Especializaci√≥n del gestor">
          <option value="" disabled>Selecciona tu especializaci√≥n</option>
          <option *ngFor="let especialidad of especializacionesDisponibles" [value]="especialidad">
            {{ especialidad }}
          </option>
        </select>
        <div class="error" *ngIf="listaForm.get('especializacion')?.invalid && listaForm.get('especializacion')?.touched">
          <span *ngIf="listaForm.get('especializacion')?.errors?.['required']">‚ö†Ô∏è La especializaci√≥n es requerida</span>
        </div>
        <div class="hint">Selecciona el √°rea de contenido en la que tienes m√°s experiencia</div>
      </div>
    </div>

    <!-- Configuraci√≥n -->
    <div class="form-section">
      <h2>Configuraci√≥n</h2>
      
      <!-- Campo Tags -->
      <div class="form-field">
        <label for="tags-section">
          Etiquetas 
          <span *ngIf="hasSelectedTags()" class="selected-count">({{ getSelectedTagsCount() }} seleccionadas)</span>
        </label>
        
        <!-- Grid de tags seleccionables -->
        <fieldset id="tags-section" class="tags-grid" aria-label="Seleccionar etiquetas para la lista">
          <legend class="sr-only">Selecciona las etiquetas que describan tu lista</legend>
          <div *ngFor="let tag of availableListTags" 
               class="tag-option">
            <input 
              type="checkbox" 
              [id]="'tag-' + tag.value"
              [checked]="isTagSelected(tag.value)"
              (change)="toggleTag(tag.value)"
              class="tag-checkbox"
              [attr.aria-describedby]="'tag-' + tag.value + '-desc'">
            <label [for]="'tag-' + tag.value" 
                   class="tag-label"
                   [id]="'tag-' + tag.value + '-desc'">
              {{ tag.label }}
            </label>
          </div>
        </fieldset>
        
        <!-- Resumen de tags seleccionados -->
        <div class="tags-summary" *ngIf="!hasSelectedTags()">
          üí° Selecciona las etiquetas que mejor describan tu lista para ayudar a otros usuarios a encontrarla
        </div>
        <div class="tags-summary selected" *ngIf="hasSelectedTags()">
          ‚úÖ <strong>{{ getSelectedTagsCount() }} etiqueta(s) seleccionada(s):</strong> {{ getSelectedTagsText() }}
        </div>
      </div>

      <!-- Campo Visible (solo para gestores) -->
      <div class="form-field" *ngIf="modo === 'gestor'">
        <label class="checkbox-label">
          <input type="checkbox" formControlName="visible">
          Lista p√∫blica
        </label>
        <div class="hint">Las listas p√∫blicas son visibles para todos los usuarios</div>
      </div>
    </div>

    <!-- Gesti√≥n de contenidos -->
    <div class="form-section">
      <h2>Contenidos de la lista</h2>
      
      <!-- Input para a√±adir contenido -->
      <div class="form-field">
        <label for="contenidoInput">A√±adir contenido</label>
        <div class="search-content-container">
          <div class="input-with-button">
            <input 
              id="contenidoInput"
              type="text" 
              [(ngModel)]="nuevoContenido"
              [ngModelOptions]="{standalone: true}"
              (input)="onBuscarContenido()"
              (blur)="cerrarSugerencias()"
              (keydown.enter)="agregarContenido()"
              (keydown.escape)="cerrarSugerencias()"
              placeholder="Escribe para buscar contenidos..."
              class="content-input"
              autocomplete="off"
              aria-label="Buscar contenidos para a√±adir a la lista">
            <button 
              type="button" 
              class="btn btn-add-content"
              (click)="agregarContenido()"
              [disabled]="!nuevoContenido.trim()">
              <span class="icon" *ngIf="!buscandoContenidos">‚ûï</span>
              <span class="icon spinner" *ngIf="buscandoContenidos">üîÑ</span>
            </button>
          </div>
          
          <!-- Sugerencias de contenidos -->
          <div class="content-suggestions" *ngIf="mostrarSugerencias && contenidosEncontrados.length > 0">
            <div class="suggestions-header">
              <span class="suggestions-title">Contenidos encontrados:</span>
            </div>
            <div 
              *ngFor="let contenido of contenidosEncontrados" 
              class="suggestion-item"
              (mousedown)="seleccionarContenido(contenido)"
              [title]="contenido.descripcion">
              <div class="suggestion-main">
                <span class="suggestion-title">{{ contenido.titulo }}</span>
                <span class="suggestion-type" [class.type-audio]="contenido.tipo === 'Audio'" [class.type-video]="contenido.tipo === 'Video'">
                  {{ contenido.tipo }}
                </span>
              </div>
              <div class="suggestion-details" *ngIf="contenido.descripcion">
                <span class="suggestion-description">{{ contenido.descripcion }}</span>
                <span class="suggestion-duration" *ngIf="contenido.duracion">
                  {{ formatDuration(contenido.duracion) }}
                </span>
              </div>
            </div>
          </div>
          
          <!-- Estado de b√∫squeda -->
          <div class="search-status" *ngIf="buscandoContenidos">
            <span class="search-loading">üîç Buscando contenidos...</span>
          </div>
          
          <div class="search-hint" *ngIf="nuevoContenido && nuevoContenido.length > 0 && nuevoContenido.length < 2">
            <span class="hint-text">Escribe al menos 2 caracteres para buscar</span>
          </div>
        </div>
      </div>

      <!-- Lista de contenidos -->
      <div class="contenidos-section">
        <div class="contenidos-header">
          <span>Contenidos a√±adidos ({{ contenidosIds.length }})</span>
          <div class="error" *ngIf="contenidosIds.length === 0 && mostrarErrorContenido">
            ‚ö†Ô∏è Debe a√±adir al menos un contenido
          </div>
        </div>
        
        <div *ngIf="contenidosIds.length === 0" class="empty-contenidos">
          <span class="icon">üì≠</span>
          <p>No hay contenidos a√±adidos</p>
        </div>
        
        <div class="contenidos-list" *ngIf="contenidosIds.length > 0">
          <div *ngFor="let contenido of contenidosIds; let i = index" class="contenido-item">
            <span class="contenido-text">{{ obtenerNombreContenido(contenido) }}</span>
            <button 
              type="button"
              class="btn btn-remove-content"
              (click)="quitarContenido(i)"
              [disabled]="!puedeEliminarContenido()"
              [title]="puedeEliminarContenido() ? 'Eliminar contenido' : 'No se puede eliminar el √∫ltimo contenido'">
              <span class="icon">üóëÔ∏è</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="modal ? onCancelar() : volver()">
        <span class="icon">{{ modal ? '‚ùå' : 'üè†' }}</span>
        {{ modal ? 'Cancelar' : 'Volver' }}
      </button>
      <button 
        type="submit" 
        class="btn btn-primary" 
        [disabled]="!puedeCrearLista()">
        <span class="icon" *ngIf="guardando">‚è≥</span>
        <span class="icon" *ngIf="!guardando">üíæ</span>
        {{ textoBotonSubmit }}
      </button>
    </div>
  </form>
</div>

<div class="lista-detail-container">
  <!-- Loading state -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando lista...</p>
  </div>

  <!-- Error state -->
  <div *ngIf="error && !loading" class="error-state">
    <div class="error-icon">âŒ</div>
    <h2>Error</h2>
    <p>{{ error }}</p>
    <button class="btn btn-primary" (click)="volver()">Volver</button>
  </div>

  <!-- Content - Solo si tiene permisos para ver -->
  <div *ngIf="!loading" class="content">
    <div *ngIf="!error && lista && puedeVerLista()">
      <!-- Contenido normal aquÃ­ -->
    <!-- Header -->
    <header class="lista-header">
      <div class="header-content">
        <div class="breadcrumb">
          <button class="breadcrumb-link" (click)="volver()">
            Listas
          </button>
          <span class="separator">/</span>
          <span class="current">{{ lista.nombre }}</span>
        </div>

        <div class="header-main">
          <div class="lista-info">
            <h1 class="lista-title">{{ lista.nombre }}</h1>
            <p class="lista-description" *ngIf="lista.descripcion">{{ lista.descripcion }}</p>
            
            <div class="lista-meta">
              <div class="meta-item">
                <span class="icon">ğŸµ</span>
                <span>{{ contenidos.length }} contenido{{ contenidos.length !== 1 ? 's' : '' }}</span>
              </div>
              
              <div class="meta-item" *ngIf="lista.tags && lista.tags.length > 0">
                Tags:
                <span class="tags">
                  <span class="tag" *ngFor="let tag of lista.tags; let last = last">
                    {{ tag }}{{ !last ? ', ' : '' }}
                  </span>
                </span>
              </div>
              
              <div class="meta-item" *ngIf="lista.visible !== undefined">
                <span class="visibility-badge" [class.public]="lista.visible" [class.private]="!lista.visible">
                  <span class="icon">{{ lista.visible ? 'ğŸŒ' : 'ğŸ”’' }}</span>
                  {{ lista.visible ? 'PÃºblica' : 'Privada' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="header-actions" *ngIf="puedeEditar()">
            <button 
              class="btn" 
              [class.btn-secondary]="!modoEdicion" 
              [class.btn-primary]="modoEdicion"
              (click)="toggleEdicion()">
              <span class="icon">{{ modoEdicion ? 'ğŸ’¾' : 'âœï¸' }}</span>
              {{ modoEdicion ? 'Guardar' : 'Editar' }}
            </button>
            <button 
              class="btn btn-secondary" 
              *ngIf="modoEdicion"
              (click)="cancelarEdicion()">
              <span class="icon">âŒ</span>
              Cancelar
            </button>
            <button class="btn btn-danger" (click)="mostrarConfirmacionEliminar()" *ngIf="esPropietario()">
              <span class="icon">ğŸ—‘ï¸</span>
              Eliminar
            </button>
          </div>

          <!-- InformaciÃ³n para usuarios sin permisos de ediciÃ³n -->
          <div class="header-info" *ngIf="!puedeEditar() && !esPropietario()">
            <div class="info-badge">
              <span class="icon">ğŸ‘ï¸</span>
              <span>Solo lectura</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Formulario de ediciÃ³n -->
    <section class="edit-section" *ngIf="modoEdicion">
      <div class="form-section">
        <h2>Editar informaciÃ³n bÃ¡sica</h2>
        
        <!-- Nombre -->
        <div class="form-field">
          <label for="nombre">Nombre de la lista *</label>
          <input 
            id="nombre"
            type="text" 
            [(ngModel)]="datosEdicion.nombre"
            class="form-input"
            placeholder="Nombre de la lista">
        </div>

        <!-- DescripciÃ³n -->
        <div class="form-field">
          <label for="descripcion">DescripciÃ³n *</label>
          <textarea 
            id="descripcion"
            [(ngModel)]="datosEdicion.descripcion"
            rows="3"
            class="form-input"
            placeholder="DescripciÃ³n de la lista"></textarea>
        </div>

        <!-- Tags -->
        <div class="form-field">
          <label for="tagsInput">Etiquetas</label>
          <input 
            id="tagsInput"
            type="text" 
            [(ngModel)]="datosEdicion.tagsInput"
            class="form-input"
            placeholder="rock, pop, jazz (separadas por comas)">
        </div>

        <!-- Visible (solo para gestores de contenido) -->
        <div class="form-field" *ngIf="esGestorDeContenido()">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="datosEdicion.visible">
            Lista pÃºblica
          </label>
        </div>
      </div>

      <!-- GestiÃ³n de contenidos en modo ediciÃ³n -->
      <div class="form-section">
        <h2>Gestionar contenidos</h2>
        
        <!-- BÃºsqueda de contenidos -->
        <div class="form-field">
          <label for="contenidoInput">AÃ±adir contenido</label>
          <div class="search-content-container">
            <div class="input-with-button">
              <input 
                id="contenidoInput"
                type="text" 
                [(ngModel)]="nuevoContenido"
                (input)="onBuscarContenido()"
                (blur)="cerrarSugerencias()"
                (keydown.enter)="agregarContenido()"
                (keydown.escape)="cerrarSugerencias()"
                placeholder="Escribe para buscar contenidos..."
                class="content-input"
                autocomplete="off">
            </div>
            
            <!-- Sugerencias -->
            <div class="content-suggestions" *ngIf="mostrarSugerencias && contenidosEncontrados.length > 0">
              <div class="suggestions-header">
                <span class="suggestions-title">Contenidos encontrados:</span>
              </div>
              <div 
                *ngFor="let contenido of contenidosEncontrados" 
                class="suggestion-item"
                (mousedown)="seleccionarContenido(contenido)">
                <div class="suggestion-main">
                  <span class="suggestion-title">{{ contenido.titulo }}</span>
                  <span class="suggestion-type">{{ contenido.tipo }}</span>
                </div>
                <div class="suggestion-details" *ngIf="contenido.descripcion">
                  <span class="suggestion-description">{{ contenido.descripcion }}</span>
                </div>
              </div>
            </div>
            
            <!-- Estado de bÃºsqueda -->
            <div class="search-status" *ngIf="buscandoContenidos">
              <span class="search-loading">ğŸ” Buscando contenidos...</span>
            </div>
          </div>
        </div>

        <!-- Lista de contenidos en ediciÃ³n -->
        <div class="contenidos-edit-list">
          <div class="contenidos-header">
            <span>Contenidos en la lista ({{ contenidosEditables.length }})</span>
          </div>
          
          <div *ngIf="contenidosEditables.length === 0" class="empty-contenidos">
            <span class="icon">ğŸ“­</span>
            <p>No hay contenidos en la lista</p>
          </div>
          
          <div class="contenidos-list" *ngIf="contenidosEditables.length > 0">
            <div *ngFor="let contenido of contenidosEditables; let i = index" class="contenido-edit-item">
              <span class="contenido-text">{{ obtenerNombreContenido(contenido) }}</span>
              <button 
                type="button"
                class="btn btn-remove-content"
                (click)="quitarContenido(i)"
                title="Eliminar contenido">
                <span class="icon">ğŸ—‘ï¸</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Contenidos (modo visualizaciÃ³n) -->
    <section class="contenidos-section" *ngIf="!modoEdicion">
      <div class="section-header">
        <h2>Contenidos ({{ contenidos.length }})</h2>
      </div>

      <!-- Empty state -->
      <div *ngIf="contenidos.length === 0" class="empty-state">
        <div class="empty-icon">ğŸ“­</div>
        <h3>No hay contenidos</h3>
        <p>Esta lista no tiene contenidos aÃ±adidos.</p>
        <button class="btn btn-primary" (click)="toggleEdicion()" *ngIf="puedeEditar()">
          <span class="icon">+</span>
          AÃ±adir contenidos
        </button>
      </div>

      <!-- Contenidos grid -->
      <div *ngIf="contenidos && contenidos.length > 0" class="contenidos-grid">
        <button 
          *ngFor="let contenido of contenidos; trackBy: trackById; let i = index" 
          class="contenido-card"
          (click)="verContenido(contenido)"
          [attr.aria-label]="'Ver contenido: ' + contenido.titulo"
          [attr.data-index]="i">
          
          <div class="card-image">
            <img 
              *ngIf="caratulaUrl(contenido)" 
              [src]="caratulaUrl(contenido)" 
              [alt]="contenido.titulo"
              class="caratula">
            <div *ngIf="!caratulaUrl(contenido)" class="caratula-placeholder">
              <span class="placeholder-icon">{{ contenido.tipo === 'VIDEO' ? 'ğŸ¬' : 'ğŸµ' }}</span>
            </div>
            <div class="card-overlay">
              <button class="play-button" [attr.aria-label]="'Reproducir ' + contenido.titulo">
                â–¶ï¸
              </button>
            </div>
          </div>

          <div class="card-content">
            <h3 class="contenido-title">{{ contenido.titulo }}</h3>
            <p class="contenido-type">{{ contenido.tipo }}</p>
            <p class="contenido-badge" [class.vip]="contenido.vip" *ngIf="contenido.vip">
              VIP
            </p>
          </div>
        </button>
      </div>
    </section>
    </div>
  </div>
</div>

<!-- Modal de confirmaciÃ³n para eliminar -->
<app-confirmation-modal
  [isVisible]="mostrarModalEliminar"
  title="Eliminar lista"
  [message]="getMensajeEliminar()"
  submessage="Esta acciÃ³n no se puede deshacer y se perderÃ¡n todos los contenidos de la lista."
  confirmText="Eliminar"
  cancelText="Cancelar"
  processingText="Eliminando..."
  [isProcessing]="eliminandoLista"
  (confirmed)="confirmarEliminarLista()"
  (cancelled)="cancelarEliminarLista()">
</app-confirmation-modal>
<!-- Header id√©ntico al del dashboard -->
<header class="dashboard-header">
  <div class="header-content">
    <div class="logo-section">
      <div class="logo">
        <img src="/EsiMedia icono sin fondo.png" alt="ESIMedia Logo" class="w-8 h-8">
        <span class="logo-text">EsiMedia</span>
      </div>
    </div>

    <nav class="nav-menu">
      <a routerLink="/dashboard" routerLinkActive="active" [routerLinkActiveOptions]="{exact:true}" class="nav-link">Inicio</a>
      <a routerLink="/dashboard/videos" routerLinkActive="active" class="nav-link">Videos</a>
      <a routerLink="/dashboard/audios" routerLinkActive="active" class="nav-link">Audios</a>
      <button (click)="irAListasPublicas()" class="nav-link nav-button">Listas P√∫blicas</button>
    </nav>

    <div class="user-section">
      <button class="notification-btn" (click)="mostrarNotificacionDummy()">
        <span class="notification-icon">üîî</span>
        <span class="notification-badge">3</span>
      </button>
      <button class="user-profile" 
              (click)="toggleUserMenu()" 
              (keydown)="onUserProfileKeydown($event)" 
              [attr.aria-expanded]="showUserMenu"
              [attr.aria-label]="'Men√∫ de usuario de ' + userName">
        <div class="user-avatar-container">
          <div [class]="getAvatarClasses()">{{ userInitial }}</div>
        </div>
        <span class="user-name">{{ userName }}</span>
        <div class="dropdown-arrow" [class.rotated]="showUserMenu">‚ñº</div>
      </button>

      <!-- Men√∫ desplegable del usuario -->
      <div class="user-dropdown" *ngIf="showUserMenu" role="menu">
        <button class="dropdown-item" (click)="irAMisListasPrivadas()" role="menuitem">
          <span class="dropdown-text">Ver mis listas privadas</span>
        </button>
        <div class="dropdown-divider"></div>
        <button class="dropdown-item logout-item" (click)="logout()" role="menuitem">
          <span class="dropdown-text">Cerrar sesi√≥n</span>
        </button>
      </div>
    </div>
  </div>
</header>
<div class="detalle-wrapper">
  <!-- Loader -->
  <div class="loader" *ngIf="cargando && !detalle">Cargando...</div>

  <!-- Error general -->
  <div class="error-banner" *ngIf="!cargando && error">{{ error }}</div>

  <div class="detalle" *ngIf="!cargando && detalle">
    <div class="cabecera">
      <div class="caratula" *ngIf="caratulaUrl()" [style.background-image]="'url(' + caratulaUrl() + ')'"></div>
      <div class="cabecera-info">
        <h1 class="titulo">{{ detalle!.titulo }}</h1>
        <!-- Se eliminan descripci√≥n y metadatos en cabecera para evitar duplicidad -->
      </div>
    </div>

    <div class="detalle-body">
      <!-- Columna principal: reproductor -->
      <div class="col-principal">
        <!-- VIDEO -->
        <div *ngIf="detalle!.tipo === 'VIDEO'" class="player-card">
          <div class="player-wrapper">
            <!-- Player: siempre renderizado; skeleton superpuesto hasta ready -->
            <ng-container *ngIf="esYoutube(); else videoDirecto">
              <iframe
                class="video-player"
                [src]="youtubeSafeUrl"
                width="100%" height="420"
                frameborder="0"
                (load)="onIframeLoaded()"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen>
              </iframe>
            </ng-container>
            <ng-template #videoDirecto>
              <video controls [src]="detalle!.referenciaReproduccion" class="video-player" preload="metadata"
                (loadedmetadata)="onVideoLoaded()"
                (canplay)="onVideoCanPlay()"
                (waiting)="onVideoWaiting()"
                (playing)="onVideoPlaying()"></video>
            </ng-template>
            <!-- Skeleton overlay -->
            <div class="player-skeleton" *ngIf="!playerReady">
              <div class="shimmer"></div>
              <span>Preparando reproductor...</span>
            </div>
          </div>
          <p class="fallback">
            ¬øProblemas? <a [href]="detalle!.referenciaReproduccion" target="_blank" rel="noopener">Abrir en pesta√±a nueva</a>.
          </p>
          <div class="buffering" *ngIf="buffering">Bufferizando...</div>
        </div>

        <!-- AUDIO: reproducci√≥n directa con <audio> y token en query (?auth=) -->
        <div *ngIf="detalle!.tipo === 'AUDIO'" class="player-card">
          <ng-container *ngIf="!audioError">
            <audio controls [src]="audioSrc()" (error)="onAudioError($event)" (loadedmetadata)="onAudioLoaded($event)"></audio>
          </ng-container>
          <div class="audio-error" *ngIf="audioError">
            {{ audioError }}
            <button class="retry-btn" (click)="reintentarAudio()">Reintentar</button>
          </div>
        </div>

        <!-- Tags debajo del reproductor, sin t√≠tulo -->
        <div class="tags-under" *ngIf="tags().length > 0">
          <span class="chip" *ngFor="let tag of tags()">#{{ tag }}</span>
        </div>
      </div>

      <!-- Columna lateral: informaci√≥n y etiquetas -->
      <aside class="col-lateral">
        <div class="info-card">
          <h3>Informaci√≥n</h3>
          <ul class="info-list">
            <li><label>Duraci√≥n:</label><b>{{ duracionTexto() }}</b></li>
            <li><label>Edad m√≠nima:</label><b>{{ edadTexto() }}</b></li>
            <li><label>Visualizaciones:</label><b>{{ visualizacionesTexto() }}</b></li>
            <li><label>Disponible hasta:</label><b>{{ fechaDisponibleTexto() }}</b></li>
            <li class="desc"><label>Descripci√≥n:</label><div class="desc-text">{{ detalle!.descripcion || 'Sin descripci√≥n' }}</div></li>
          </ul>
        </div>
      </aside>
    </div>
  </div>
</div>

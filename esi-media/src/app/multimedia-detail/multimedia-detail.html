<header class="dashboard-header">
  <div class="header-content">
    <div class="logo-section">
      <div class="logo">
          <img src="/EsiMedia icono sin fondo.png" alt="ESIMedia Logo" class="w-8 h-8">
          <span class="logo-text">EsiMedia</span>
      </div>
    </div>
    <nav class="nav-menu">
      <a routerLink="/multimedia" routerLinkActive="active" [routerLinkActiveOptions]="{exact:true}" class="nav-link">Inicio</a>
      <a routerLink="/multimedia/videos" routerLinkActive="active" class="nav-link">Videos</a>
      <a routerLink="/multimedia/audios" routerLinkActive="active" class="nav-link">Audios</a>
      <a routerLink="/dashboard/listas-publicas" routerLinkActive="active" class="nav-link">Listas Públicas</a>
    </nav>
    <div class="user-section">
    </div>
  </div>
</header>
<div class="detalle-wrapper">
  <!-- Loader -->
  <div class="loader" *ngIf="cargando && !detalle">Cargando...</div>

  <!-- Error general -->
  <div class="error-banner" *ngIf="!cargando && error">{{ error }}</div>

  <div class="detalle" *ngIf="!cargando && detalle">
    <div class="cabecera">
      <div class="caratula" *ngIf="caratulaUrl()" [style.background-image]="'url(' + caratulaUrl() + ')'">
        <div class="vip-badge" *ngIf="detalle!.vip">VIP</div>
      </div>
      <div class="cabecera-info">
        <h1 class="titulo">{{ detalle!.titulo }}</h1>
        <p class="descripcion" *ngIf="detalle!.descripcion">{{ detalle!.descripcion }}</p>
        <div class="meta" *ngIf="duracion() || tags().length">
          <span class="chip" *ngIf="duracion()">⏱ {{ duracion() }}s</span>
          <span class="chip" *ngFor="let tag of tags()">#{{ tag }}</span>
        </div>
      </div>
      <!-- Desplegable de listas privadas -->
      <div class="cabecera-actions">
        <div class="dropdown-listas" *ngIf="listasPrivadas.length > 0">
          <button class="btn-dropdown-listas" (click)="toggleDropdownListas()">
            <span>Añadir a lista</span>
            <span class="dropdown-arrow" [class.rotated]="mostrarDropdownListas">▼</span>
          </button>
          <div class="dropdown-menu-listas" *ngIf="mostrarDropdownListas" role="menu">
            <div class="dropdown-item-lista" 
                 *ngFor="let lista of listasPrivadas" 
                 (click)="incluirALista(lista)"
                 (keydown)="onListaKeyDown($event, lista)"
                 tabindex="0"
                 role="menuitem">
              <span class="lista-nombre">{{ lista.nombre }}</span>
              <span class="lista-info">{{ lista.contenidosIds?.length || 0 }} elementos</span>
            </div>
            <div class="dropdown-divider" *ngIf="listasPrivadas.length > 0"></div>
            <div class="dropdown-item-lista nueva-lista" 
                 (click)="crearNuevaLista()"
                 (keydown)="onNuevaListaKeyDown($event)"
                 tabindex="0"
                 role="menuitem">
              <span class="lista-nombre">+ Crear nueva lista</span>
            </div>
          </div>
        </div>
        <!-- Mensaje si no hay listas -->
        <button class="btn-primera-lista" *ngIf="listasPrivadas.length === 0" (click)="crearNuevaLista()">
          <span>Crear primera lista</span>
        </button>
      </div>
    </div>

    <!-- VIDEO -->
    <div *ngIf="detalle!.tipo === 'VIDEO'" class="player-card">
      <div class="player-wrapper">
        <!-- Player: siempre renderizado; skeleton superpuesto hasta ready -->
        <ng-container *ngIf="esYoutube(); else videoDirecto">
          <iframe
            class="video-player"
            [src]="youtubeSafeUrl"
            width="100%" height="360"
            frameborder="0"
            (load)="onIframeLoaded()"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen>
          </iframe>
        </ng-container>
        <ng-template #videoDirecto>
          <video controls [src]="detalle!.referenciaReproduccion" class="video-player" preload="metadata"
            (loadedmetadata)="onVideoLoaded()"
            (canplay)="onVideoCanPlay()"
            (waiting)="onVideoWaiting()"
            (playing)="onVideoPlaying()"></video>
        </ng-template>
        <!-- Skeleton overlay -->
        <div class="player-skeleton" *ngIf="!playerReady">
          <div class="shimmer"></div>
          <span>Preparando reproductor...</span>
        </div>
      </div>
      <p class="fallback">
        ¿Problemas? <a [href]="detalle!.referenciaReproduccion" target="_blank" rel="noopener">Abrir en pestaña nueva</a>.
      </p>
      <div class="buffering" *ngIf="buffering">Bufferizando...</div>
    </div>

    <!-- AUDIO: reproducción directa con <audio> y token en query (?auth=) -->
    <div *ngIf="detalle!.tipo === 'AUDIO'" class="player-card">
      <ng-container *ngIf="!audioError">
        <audio controls [src]="audioSrc()" (error)="onAudioError($event)" (loadedmetadata)="onAudioLoaded($event)"></audio>
      </ng-container>
      <div class="audio-error" *ngIf="audioError">
        {{ audioError }}
        <button class="retry-btn" (click)="reintentarAudio()">Reintentar</button>
      </div>
    </div>
  </div>
</div>

<!-- Notificaciones -->
<div class="notification-container" *ngIf="notificacion">
  <div class="notification" [class]="notificacion.tipo">
    <span>{{ notificacion.mensaje }}</span>
    <button class="close-notification" (click)="cerrarNotificacion()" type="button">×</button>
  </div>
</div>

```

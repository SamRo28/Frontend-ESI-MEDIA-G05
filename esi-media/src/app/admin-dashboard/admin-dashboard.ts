import { Component, OnInit, ChangeDetectorRef } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { AdminService, Usuario } from '../services/admin.service';

@Component({
  selector: 'app-admin-dashboard',
  templateUrl: './admin-dashboard.html',
  styleUrls: ['./admin-dashboard.css'],
  standalone: true,
  imports: [CommonModule, FormsModule]
})
export class AdminDashboardComponent implements OnInit {
  activeTab = 'inicio';
  showForm = false;
  usuarios: Usuario[] = [];
  newUser = {
    nombre: '',
    apellidos: '',
    email: '',
    contrasenia: '',
    repetirContrasenia: '',
    foto: '',
    departamento: '',
    rol: 'Administrador' as 'Administrador' | 'Gestor',
    // Campos espec√≠ficos para Gestor
    alias: '',
    descripcion: '',
    especialidad: '',
    tipoContenido: ''
  };
  errorMessage = '';
  successMessage = '';
  isCreating = false;
  isSuccess = false; // Nueva propiedad para mostrar estado de √©xito
  
  // Propiedades para manejar errores de validaci√≥n
  fieldsWithError: string[] = [];

  constructor(
    private adminService: AdminService,
    private cdr: ChangeDetectorRef
  ) {}

  ngOnInit() {
    this.loadUsuarios();
  }

  loadUsuarios() {
    this.adminService.getUsuarios().subscribe({
      next: (usuarios) => {
        this.usuarios = usuarios;
      },
      error: (error: any) => {
        console.error('Error al cargar usuarios:', error);
        this.errorMessage = 'Error al cargar la lista de usuarios';
      }
    });
  }

  setActiveTab(tab: string) {
    this.activeTab = tab;
    if (tab === 'usuarios') {
      this.loadUsuarios();
    }
    this.resetMessages();
  }

  resetMessages() {
    this.errorMessage = '';
    this.successMessage = '';
    this.isCreating = false; // Asegurar que se restablezca el estado de loading
    this.isSuccess = false; // Resetear estado de √©xito
    this.fieldsWithError = []; // Limpiar errores de campos
  }

  toggleForm() {
    this.showForm = !this.showForm;
    if (!this.showForm) {
      this.resetForm();
      this.resetMessages();
    } else {
      // Limpiar mensajes cuando se abre el formulario
      this.resetMessages();
    }
  }

  onFileSelected(event: any) {
    const file = event.target.files[0];
    if (file) {
      this.newUser.foto = file.name;
    }
  }

  onRoleChange(role: 'Administrador' | 'Gestor') {
    this.newUser.rol = role;
  }

  createUser() {
    console.log('üéØ COMPONENTE: *** createUser() EJECUTADO ***');
    console.log('üìã COMPONENTE: Datos del formulario:', this.newUser);
    console.log('üìã COMPONENTE: isCreating antes:', this.isCreating);
    
    this.resetMessages();
    
    // Limpiar errores anteriores
    this.fieldsWithError = [];
    
    // Validar campos obligatorios seg√∫n el rol
    let requiredFields: string[];
    
    if (this.newUser.rol === 'Gestor') {
      requiredFields = ['nombre', 'apellidos', 'email', 'contrasenia', 'alias', 'especialidad', 'tipoContenido'];
    } else {
      requiredFields = ['nombre', 'apellidos', 'email', 'contrasenia', 'departamento'];
    }
    
    const emptyFields = requiredFields.filter(field => !this.newUser[field as keyof typeof this.newUser]);
    
    console.log('‚úÖ COMPONENTE: Validaci√≥n campos vac√≠os - Tipo de usuario:', this.newUser.rol);
    console.log('‚úÖ COMPONENTE: Validaci√≥n campos vac√≠os - Campos requeridos:', requiredFields);
    console.log('‚úÖ COMPONENTE: Validaci√≥n campos vac√≠os - Campos vac√≠os encontrados:', emptyFields);
    
    if (emptyFields.length > 0) {
      console.log('‚ùå COMPONENTE: Validaci√≥n fall√≥ - campos vac√≠os:', emptyFields);
      this.fieldsWithError = [...emptyFields];
      this.errorMessage = `‚ùå Complete todos los campos obligatorios: ${emptyFields.join(', ')}`;
      return;
    }

    // Validar contrase√±as coincidentes
    console.log('‚úÖ COMPONENTE: Validaci√≥n contrase√±as - contrasenia:', this.newUser.contrasenia);
    console.log('‚úÖ COMPONENTE: Validaci√≥n contrase√±as - repetirContrasenia:', this.newUser.repetirContrasenia);
    
    if (this.newUser.contrasenia !== this.newUser.repetirContrasenia) {
      console.log('‚ùå COMPONENTE: Validaci√≥n fall√≥ - contrase√±as no coinciden');
      this.fieldsWithError = ['contrasenia', 'repetirContrasenia'];
      this.errorMessage = '‚ùå Las contrase√±as no coinciden. Verifique que ambas contrase√±as sean id√©nticas.';
      return;
    }

    // Validar email
    console.log('‚úÖ COMPONENTE: Validaci√≥n email:', this.newUser.email);
    
    if (!this.isValidEmail(this.newUser.email)) {
      console.log('‚ùå COMPONENTE: Validaci√≥n fall√≥ - email inv√°lido');
      this.fieldsWithError = ['email'];
      this.errorMessage = '‚ùå Por favor, ingrese un correo electr√≥nico v√°lido (ejemplo: usuario@dominio.com).';
      return;
    }

    console.log('üéâ COMPONENTE: Todas las validaciones pasaron!');
    
    // Solo activar loading despu√©s de validar
    this.isCreating = true;
    console.log('üîÑ COMPONENTE: isCreating = true');

    // Construir userData seg√∫n el tipo de usuario
    let userData: any = {
      nombre: this.newUser.nombre,
      apellidos: this.newUser.apellidos,
      email: this.newUser.email,
      contrasenia: this.newUser.contrasenia,
      foto: this.newUser.foto || undefined,
      rol: this.newUser.rol
    };

    // Agregar campos espec√≠ficos seg√∫n el rol
    if (this.newUser.rol === 'Gestor') {
      userData = {
        ...userData,
        alias: this.newUser.alias,
        descripcion: this.newUser.descripcion || undefined,
        especialidad: this.newUser.especialidad,
        tipoContenido: this.newUser.tipoContenido
      };
    } else {
      userData.departamento = this.newUser.departamento;
    }

    console.log('üöÄ COMPONENTE: Preparando datos para env√≠o...');
    console.log('üì§ COMPONENTE: userData creado:', userData);
    console.log('üìû COMPONENTE: *** AHORA LLAMANDO A adminService.crearUsuario() ***');

    // Variable para el timeout de respaldo
    let backupTimeout: any = null;
    
    // Implementar timeout de respaldo m√°s largo ahora que sabemos que el server responde
    backupTimeout = setTimeout(() => {
      if (this.isCreating) {
        console.log('‚ö†Ô∏è TIMEOUT DE RESPALDO: El servidor tard√≥ m√°s de 8 segundos');
        this.isCreating = false;
        this.cdr.detectChanges(); // Forzar actualizaci√≥n en timeout
        this.errorMessage = 'La operaci√≥n tard√≥ m√°s tiempo del esperado, pero es posible que el administrador se haya creado.';
        
        // Recargar usuarios para verificar
        setTimeout(() => {
          this.loadUsuarios();
        }, 1000);
        
        // Limpiar error despu√©s de 6 segundos
        setTimeout(() => {
          this.errorMessage = '';
        }, 6000);
      }
    }, 8000);

    this.adminService.crearUsuario(userData).subscribe({
      next: (response: any) => {
        console.log('‚úÖ √âXITO: Respuesta completa del servidor:', response);
        clearTimeout(backupTimeout); // Cancelar timeout de respaldo
        
        // Extraer el nombre de la respuesta del servidor o usar el del formulario
        const nombreCreado = response?.nombre || this.newUser.nombre;
        
        // CAMBIOS CR√çTICOS DE ESTADO
        console.log('üîÑ CAMBIANDO ESTADOS:');
        console.log('  isCreating:', this.isCreating, '-> false');
        console.log('  isSuccess:', this.isSuccess, '-> true');
        
        this.isCreating = false;
        this.isSuccess = true;
        
        // Mensaje de √©xito espec√≠fico por rol
        const tipoUsuario = this.newUser.rol === 'Gestor' ? 'Gestor de Contenido' : 'Administrador';
        this.successMessage = `¬°${tipoUsuario} "${nombreCreado}" creado exitosamente!`;
        
        console.log('‚úÖ ESTADOS ACTUALIZADOS:');
        console.log('  isCreating:', this.isCreating);
        console.log('  isSuccess:', this.isSuccess);
        console.log('  successMessage:', this.successMessage);
        
        // FORZAR DETECCI√ìN DE CAMBIOS
        this.cdr.detectChanges();
        console.log('üéâ Detecci√≥n de cambios ejecutada - deber√≠a mostrar pantalla de √©xito');
      },
      error: (error: any) => {
        console.error('‚ùå Error completo al crear usuario:', error);
        console.log('üìä Status del error:', error.status);
        console.log('üìù Mensaje del error:', error.error);
        console.log('üåê URL completa:', error.url);
        
        clearTimeout(backupTimeout); // Cancelar timeout de respaldo
        this.isCreating = false;
        this.cdr.detectChanges(); // Forzar actualizaci√≥n en errores tambi√©n
        
        let mensajeError = 'Error desconocido';
        
        // Detectar espec√≠ficamente errores de CORS o conexi√≥n
        if (error.status === 0 && error.error?.message?.includes('Failed to fetch')) {
          mensajeError = 'Error de conexi√≥n CORS. El backend no est√° ejecut√°ndose o hay un problema de configuraci√≥n. Por favor, inicia el servidor backend.';
        } else if (error.status === 'timeout') {
          mensajeError = 'La conexi√≥n tard√≥ demasiado tiempo. Es posible que el administrador se haya creado correctamente.';
          // En caso de timeout, asumir que pudo haberse creado y recargar usuarios
          setTimeout(() => {
            this.loadUsuarios();
          }, 1000);
        } else if (error.status === 0) {
          mensajeError = 'No se pudo conectar con el servidor. Verifica que el backend est√© ejecut√°ndose en el puerto 8080.';
        } else if (error.error?.mensaje) {
          // Mensaje del backend
          mensajeError = error.error.mensaje;
          
          // Mejorar mensajes espec√≠ficos de MongoDB
          if (mensajeError.includes('E11000 duplicate key error')) {
            if (mensajeError.includes('email')) {
              mensajeError = 'El email ya est√° registrado. Por favor, usa un email diferente.';
            } else {
              mensajeError = 'Ya existe un registro con estos datos. Verifica la informaci√≥n.';
            }
          } else if (mensajeError.includes('Write operation error')) {
            mensajeError = 'Error de base de datos. Por favor, contacta al administrador del sistema.';
          }
        } else if (error.error?.message) {
          mensajeError = error.error.message;
        } else if (error.status === 500) {
          mensajeError = 'Error interno del servidor. Por favor, int√©ntalo de nuevo m√°s tarde.';
        } else if (error.status === 400) {
          mensajeError = 'Datos inv√°lidos. Verifica la informaci√≥n ingresada.';
        } else if (error.status) {
          mensajeError = `Error del servidor: ${error.status} - ${error.statusText || 'Error HTTP'}`;
        }
        
        this.errorMessage = mensajeError;
        
        // Limpiar el mensaje despu√©s de 10 segundos
        setTimeout(() => {
          this.errorMessage = '';
        }, 10000);
      }
    });
  }

  private isValidEmail(email: string): boolean {
    const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
    return emailRegex.test(email);
  }

  resetForm() {
    this.newUser = {
      nombre: '',
      apellidos: '',
      email: '',
      contrasenia: '',
      repetirContrasenia: '',
      foto: '',
      departamento: '',
      rol: 'Administrador',
      // Campos espec√≠ficos para Gestor
      alias: '',
      descripcion: '',
      especialidad: '',
      tipoContenido: ''
    };
    this.resetMessages();
  }

  getUsuariosActivos(): number {
    return this.usuarios.filter(u => !u.bloqueado).length;
  }

  getAdministradores(): number {
    return this.usuarios.filter(u => u.rol === 'Administrador').length;
  }

  // M√©todo para verificar si un campo tiene error
  hasFieldError(fieldName: string): boolean {
    return this.fieldsWithError.includes(fieldName);
  }

  // M√©todo para salir del formulario despu√©s del √©xito
  exitForm() {
    this.showForm = false;
    this.resetForm();
    this.loadUsuarios(); // Recargar la lista de usuarios
    
    // Mostrar mensaje de √©xito en la vista principal
    const nombreCreado = this.newUser.nombre || 'nuevo administrador';
    this.successMessage = `‚úÖ El administrador "${nombreCreado}" ha sido registrado correctamente en el sistema.`;
    
    // Limpiar el mensaje despu√©s de 5 segundos
    setTimeout(() => {
      this.successMessage = '';
    }, 5000);
  }



  getUsuariosBloqueados(): number {
    return this.usuarios.filter(u => u.bloqueado).length;
  }


}